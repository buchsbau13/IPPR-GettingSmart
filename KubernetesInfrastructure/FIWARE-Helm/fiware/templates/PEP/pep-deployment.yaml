{{- $image := .Values.pep.image -}}
{{- $idm := .Values.pep.idm }}
{{- $keyrock := .Values.keyrock}}
{{- range $pep :=  .Values.pep.instances }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pep-{{$pep.name}}
spec:
  selector:
    matchLabels:
      run: pep-{{$pep.name}}
  replicas: 1
  template:
    metadata:
      labels:
        run: pep-{{$pep.name}}
    spec:
      containers:
      - name: pep-{{$pep.name}}
        image: {{$image}}
        ports:
        - containerPort: {{$pep.port}}
        volumeMounts:
        - mountPath: /opt/fiware-pep-proxy/config.js
          name: pep-{{$pep.name}}-config
          subPath: config.js
        env:
        - name: PEP_PROXY_AUTH_ENABLED
          value: "true"
        - name: PEP_PROXY_IDM_HOST
          value: {{ if $keyrock.debug_local }}"keyrock-external"{{else}}{{$idm.host | quote}}{{end}}
        - name: PEP_PROXY_IDM_PORT
          value: {{ if $keyrock.debug_local }}{{ $keyrock.debug_local.port | quote}}{{else}}{{ $idm.port | quote }}{{end}}
        - name: PEP_PROXY_PORT
          value: {{ $pep.port | quote }}
        - name: PEP_PROXY_IDM_SSL_ENABLED
          value: "false"
        - name: PEP_PROXY_APP_HOST
          value: {{ $pep.host | quote }}
        - name: PEP_PROXY_APP_PORT
          value: {{ $pep.port | quote }}
        - name: PEP_PROXY_APP_ID
          value: {{ $pep.app_id | quote }}
        - name: PEP_PROXY_USERNAME
          value: {{ $pep.username | quote }}
        - name: PEP_PASSWORD
          value: {{ $pep.password | quote }}
      restartPolicy: Always
      volumes:
      - name: pep-{{$pep.name}}-config
        configMap:
          name: pep-{{$pep.name}}-config
{{- end }}
